# 一、Supabase 概述

Supabase 是一个开源的 Backend as a Service（BaaS）平台，基于 PostgreSQL，集成了认证、数据库、存储、实时推送，边缘函数等后端能力。它的目标是让开发者像用 Firebase 一样简单地构建现代 Web 应用，但拥有开源、可自托管、强大 SQL 能力等优势。

---

## 二、核心能力

### Authentication
A complete user management system that works without any additional tools.
### Storage
Store, organize, and serve any file types of any size from multiple buckets.
### Edge Functions
Write custom code without deploying or scaling servers, with fast deploy times and low latency.
### Realtime
Listen to your PostgreSQL database in realtime via websockets.

---

## 三、数据库字段迁移

### 1. 表结构需手动创建
- Supabase 不会自动为你创建业务表，需在 SQL Editor 或迁移脚本中手动建表。
- 推荐使用 SQL migration 文件（如 `migrations/20230712094349_init.sql`）统一管理表结构。
- 例如：

```sql
create table if not exists public.todos (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null,
  task text not null,
  is_complete boolean default false,
  inserted_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

- 测试/开发环境建议用迁移脚本一键初始化，避免手动操作遗漏。

### 2. 数据库迁移与版本管理
- 推荐用 Supabase CLI 或 SQL migration 工具管理数据库 schema。
- 迁移脚本应包含表结构、索引、初始数据、RLS 策略等。
- 多人协作时，统一迁移流程可避免环境不一致。

---

## 四、RLS（Row Level Security）行级安全机制详解

RLS 是 PostgreSQL 的原生特性，也是 Supabase 多用户数据隔离的核心。

### RLS 原理
- 启用 RLS 后，所有对表的操作都需通过策略（Policy）校验。
- 策略可针对 SELECT、INSERT、UPDATE、DELETE 分别定义。
- 可用 `auth.uid()`、`auth.role()` 等 Supabase 内置函数实现基于用户、角色的权限控制。

### 典型策略示例
假设有 todos 表，每条数据有 user_id 字段：

```sql
alter table todos enable row level security;

create policy "Individuals can view their own todos."
  on todos for select
  using (user_id = auth.uid());

create policy "Individuals can insert their own todos."
  on todos for insert
  with check (user_id = auth.uid());

create policy "Individuals can update their own todos."
  on todos for update
  using (user_id = auth.uid());

create policy "Individuals can delete their own todos."
  on todos for delete
  using (user_id = auth.uid());
```

- 这样每个用户只能操作自己的数据，安全隔离。
- RLS 策略可组合复杂条件，如多租户、角色分级、时间窗口等。

### Storage RLS
Supabase Storage 也支持 RLS。例如：

```sql
create policy "Authenticated users can access bucket"
on storage.objects
for all
using (
  bucket_id = 'your_bucket'
  and auth.role() = 'authenticated'
);
```

---

## 五、API 自动生成机制

- Supabase 基于 PostgREST 自动为每个表生成 RESTful API。
- 支持标准 HTTP 动词（GET/POST/PATCH/DELETE）。
- 支持复杂过滤、嵌套、分页、排序。
- 权限完全由 RLS 控制，API 层无需额外鉴权代码。
- GraphQL 支持通过 pg_graphql 扩展实现。

---

## 六、实时推送底层原理

- Supabase Realtime 监听 PostgreSQL 的 Logical Replication Slot。
- 数据库变更通过 WebSocket 推送到客户端。
- 支持多路复用、断线重连、消息去重。
- Broadcast/Presence 通过专用通道实现低延迟消息同步。
- 前端只需订阅表或频道即可实时获取数据变更。

---

## 七、存储权限与多级目录

- 上传文件时直接指定路径（如 `images/avatar.png`），无需手动建目录。
- 目录结构由对象 key 决定，支持多级嵌套。
- 结合 RLS，可实现如“每个用户只能访问自己目录下文件”的权限模型。

```ts
const filePath = `user_${userId}/images/${fileName}`
const { error } = await supabase.storage.from('bucket').upload(filePath, file)
```

---

## 八、Edge Functions 技术详解

Supabase Edge Functions 是一种在全球分布式边缘节点上运行的 TypeScript 服务器端函数。它们基于 Deno 运行时，支持 TypeScript 和 WASM，允许你在离用户更近的地方执行自定义逻辑，比如处理 Webhook、集成第三方服务（如 Stripe）、自定义 API 等。

这些代码会在“边缘节点”上运行，意思是会在离用户最近的服务器执行，响应速度更快。

### 1. 技术原理
- 采用 Deno 运行时，支持 TypeScript/JavaScript，安全沙箱隔离。
- 部署在 Supabase 的边缘网络，自动弹性伸缩。
- 支持 HTTP 触发、定时任务、Webhook 等多种调用方式。

### 2. 应用场景
- 业务逻辑扩展（如自定义 API、数据处理、第三方集成）。
- Webhook 处理（如 Stripe、GitHub 回调）。
- 低延迟 API（如地理位置相关、A/B 测试、动态内容渲染）。

### 3. 与传统 Serverless 的对比
- Edge Functions 部署在边缘节点，响应更快，适合全球用户。
- 支持 Deno 原生 API，兼容 TypeScript。
- 与 Supabase Auth、数据库、存储无缝集成。

### 4. 调用方式
- 通过 HTTP(S) 直接请求，如 `https://<project>.functions.supabase.co/<function>`。
- 可在前端、后端、第三方服务中调用。
- 支持自定义 header、鉴权、环境变量等。

### 5. 示例

```ts
// functions/hello-world/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

serve((req) => new Response("Hello from Supabase Edge Function!"));
```

- 部署后即可通过 HTTP 访问，适合微服务、API 扩展等场景。

---


## 十、实际开发经验

- Next.js + Supabase 可快速实现全栈应用。
- RLS 策略让多用户数据隔离变得极其简单。
- 存储服务适合图片、文档等多媒体场景，权限灵活。
- Edge Functions 适合自定义 API、Webhook、边缘计算等需求。
- 实时推送极大提升协作类、互动类应用体验。
- 遇到问题可查阅官方文档或社区，支持活跃。
